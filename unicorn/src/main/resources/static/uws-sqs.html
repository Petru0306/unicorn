<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/unicornicon.png">
    <link rel="apple-touch-icon" href="/unicornicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWS-SQS - Message Queue Service</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
        }

        /* Headings - Montserrat */
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        /* Brand title and subtitle - Montserrat */
        .brand-title, .brand-subtitle {
            font-family: 'Montserrat', sans-serif;
        }

        /* Navigation links - Poppins */
        .nav-link {
            font-family: 'Poppins', sans-serif;
        }

        /* Button text - Poppins */
        .btn {
            font-family: 'Poppins', sans-serif;
        }

        /* Table headers - Montserrat */
        .table th {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        /* Modal titles - Montserrat */
        .modal-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        /* Form labels - Montserrat */
        .form-label {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            gap: 0.5rem;
        }

        .brand-logo {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .brand-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #4a4afb;
            line-height: 1;
            letter-spacing: 0.5px;
        }

        .brand-subtitle {
            font-size: 0.7rem;
            font-weight: bold;
            color: #4a4afb;
            line-height: 1;
            letter-spacing: 0.3px;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #495057;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-link i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
        }

        .top-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar-toggle {
                display: block !important;
            }
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }
        .header-section {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px 15px 0 0 !important;
            border-bottom: none;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
        }
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
        }
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: none;
            font-weight: 600;
        }
        .badge {
            border-radius: 8px;
            padding: 6px 12px;
        }
        .queue-stats {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .message-content {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .loading {
            display: none;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .modal-content {
            border-radius: 15px;
        }
        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .queue-detail-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard.html" class="sidebar-brand">
                <img src="/unicornicon.png?v=1" alt="Unicorn Logo" class="brand-logo">
                <div class="brand-text">
                    <div class="brand-title">UNICORN</div>
                    <div class="brand-subtitle">WEB SERVICES</div>
                </div>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="/dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-billing.html" class="nav-link">
                    <i class="fas fa-credit-card"></i>
                    UWS-Billing
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-monitoring.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    UWS-Monitoring
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-s3.html" class="nav-link">
                    <i class="fas fa-cloud"></i>
                    UWS-S3
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-compute.html" class="nav-link">
                    <i class="fas fa-server"></i>
                    UWS-Compute
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-lambda.html" class="nav-link">
                    <i class="fas fa-code"></i>
                    UWS-Lambda
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-rdb.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-RDB
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-sqs.html" class="nav-link">
                    <i class="fas fa-envelope-open-text"></i>
                    UWS-SQS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-nosql.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-NoSQL
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-ai.html" class="nav-link">
                    <i class="fas fa-brain"></i>
                    UWS-AI
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-secrets.html" class="nav-link">
                    <i class="fas fa-key"></i>
                    UWS-Secrets
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-dns.html" class="nav-link">
                    <i class="fas fa-globe"></i>
                    UWS-DNS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-iam.html" class="nav-link">
                    <i class="fas fa-users-cog"></i>
                    UWS-IAM
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="sidebar-toggle me-3" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0">UWS-SQS Message Queue Service</h4>
            </div>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>

        <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section text-center">
                <h1><i class="fas fa-envelope-open-text"></i> UWS-SQS Message Queue Service</h1>
                <p class="lead mb-0">Create, manage, and monitor your message queues with secure JWT authentication</p>
            </div>

            <!-- Create Queue Section -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-plus-circle"></i> Create New Queue</h5>
                </div>
                <div class="card-body">
                    <form id="createQueueForm">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="queueName" class="form-label">Queue Name *</label>
                                <input type="text" class="form-control" id="queueName" required>
                            </div>
                            <div class="col-md-4">
                                <label for="visibilityTimeout" class="form-label">Visibility Timeout (seconds)</label>
                                <input type="number" class="form-control" id="visibilityTimeout" value="30" min="1" max="43200">
                                <small class="text-muted">Default: 30 seconds</small>
                            </div>
                            <div class="col-md-4">
                                <label for="retentionTime" class="form-label">Retention Time (seconds)</label>
                                <input type="number" class="form-control" id="retentionTime" value="345600" min="60" max="1209600">
                                <small class="text-muted">Default: 4 days</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Queue
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Queues List -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list"></i> Your Queues</h5>
                    <button class="btn btn-info" onclick="loadQueues()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="queuesList" class="loading">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Section -->
            <div id="messagesSection" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope"></i> Queue Messages - <span id="currentQueueName"></span></h5>
                    </div>
                    <div class="card-body">
                        <!-- Add Message Form -->
                        <div class="queue-detail-card">
                            <h6><i class="fas fa-plus"></i> Add Message</h6>
                            <form id="addMessageForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label for="messageContent" class="form-label">Message Content</label>
                                        <textarea class="form-control" id="messageContent" rows="3" placeholder="Enter your message content (text or JSON)" required></textarea>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-paper-plane"></i> Send Message
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Queue Status -->
                        <div class="queue-detail-card mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-bar"></i> Queue Status</h6>
                                    <div id="queueStatus">
                                        <p class="text-muted">Select a queue to view its status</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-clock"></i> Visibility Timeout</h6>
                                    <div id="visibilityInfo">
                                        <p class="text-muted">Queue timeout information will appear here</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Message Actions -->
                        <div class="queue-detail-card">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-cogs"></i> Queue Operations</h6>
                                    <small class="text-muted">Operations on queue: <strong>${currentQueueName}</strong></small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-info me-2" onclick="loadMessages(false)" title="View messages without removing them from queue">
                                            <i class="fas fa-eye"></i> Peek Messages
                                        </button>
                                        <button class="btn btn-success me-2" onclick="loadMessages(true)" title="Receive messages and make them invisible for 30 seconds">
                                            <i class="fas fa-download"></i> Receive Messages
                                        </button>
                                        <button class="btn btn-warning" onclick="loadMessages()" title="Refresh message list">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Operation Explanation -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> How Queue Operations Work:</h6>
                                        <ul class="mb-0">
                                            <li><strong>Peek Messages:</strong> View messages without removing them from the queue</li>
                                            <li><strong>Receive Messages:</strong> Get messages and make them invisible for 30 seconds (they will reappear after timeout)</li>
                                            <li><strong>Delete Message:</strong> Permanently remove a message from the queue</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Table -->
                        <div id="messagesList" class="loading">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Detail Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-envelope-open"></i> Message Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="messageDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentQueueId = null;
        let currentQueueName = null;

        // Check authentication on page load
        window.addEventListener('load', function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            loadQueues();
        });

        // Create Queue Form
        document.getElementById('createQueueForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createQueue();
        });

        // Add Message Form
        document.getElementById('addMessageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addMessage();
        });

        function getAuthHeaders() {
            const token = localStorage.getItem('jwtToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            };
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.main-container').insertBefore(alertDiv, document.querySelector('.header-section').nextSibling);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        async function createQueue() {
            const queueName = document.getElementById('queueName').value;
            const visibilityTimeout = document.getElementById('visibilityTimeout').value;
            const retentionTime = document.getElementById('retentionTime').value;

            try {
                const response = await fetch('/api/uws-sqs/queues', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        queueName: queueName,
                        visibilityTimeout: parseInt(visibilityTimeout),
                        retentionTime: parseInt(retentionTime)
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Queue created successfully!');
                    document.getElementById('createQueueForm').reset();
                    loadQueues();
                } else {
                    showAlert(data.error || 'Failed to create queue', 'danger');
                }
            } catch (error) {
                showAlert('Error creating queue: ' + error.message, 'danger');
            }
        }

        async function loadQueues() {
            const queuesList = document.getElementById('queuesList');
            queuesList.style.display = 'block';
            queuesList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

            try {
                const response = await fetch('/api/uws-sqs/queues', {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayQueues(data.queues);
                } else {
                    showAlert(data.error || 'Failed to load queues', 'danger');
                }
            } catch (error) {
                showAlert('Error loading queues: ' + error.message, 'danger');
            }
        }

        function displayQueues(queues) {
            const queuesList = document.getElementById('queuesList');
            
            if (queues.length === 0) {
                queuesList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>No queues found. Create your first queue above!</p></div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Queue Name</th>
                                <th>Messages</th>
                                <th>Visibility Timeout</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            queues.forEach(queue => {
                const createdAt = new Date(queue.createdAt).toLocaleString();
                html += `
                    <tr>
                        <td><strong>${queue.queueName}</strong></td>
                        <td>
                            <span class="badge bg-primary">${queue.visibleMessages} visible</span>
                            <span class="badge bg-secondary">${queue.totalMessages} total</span>
                        </td>
                        <td>${queue.visibilityTimeout}s</td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-info btn-sm me-1" onclick="viewQueue(${queue.id}, '${queue.queueName}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteQueue(${queue.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            queuesList.innerHTML = html;
        }

        async function deleteQueue(queueId) {
            if (!confirm('Are you sure you want to delete this queue? All messages will be lost.')) {
                return;
            }

            try {
                const response = await fetch(`/api/uws-sqs/queues/${queueId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Queue deleted successfully!');
                    if (currentQueueId === queueId) {
                        hideMessagesSection();
                    }
                    loadQueues();
                } else {
                    showAlert(data.error || 'Failed to delete queue', 'danger');
                }
            } catch (error) {
                showAlert('Error deleting queue: ' + error.message, 'danger');
            }
        }

        function viewQueue(queueId, queueName) {
            currentQueueId = queueId;
            currentQueueName = queueName;
            document.getElementById('currentQueueName').textContent = queueName;
            document.getElementById('messagesSection').style.display = 'block';
            // Don't automatically load messages - user must click "Peek Messages"
            // loadMessages(false);
            
            // Clear the messages list and show a message to click "Peek Messages"
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-eye fa-3x mb-3"></i><p>Click "Peek Messages" to view messages in this queue.</p></div>';
            
            // Update queue status
            updateQueueStatus(queueId, queueName);
        }

        async function updateQueueStatus(queueId, queueName) {
            try {
                const response = await fetch(`/api/uws-sqs/queues`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const queue = data.queues.find(q => q.id === queueId);
                    
                    if (queue) {
                        const queueStatus = document.getElementById('queueStatus');
                        const visibilityInfo = document.getElementById('visibilityInfo');
                        
                        queueStatus.innerHTML = `
                            <div class="row">
                                <div class="col-6">
                                    <span class="badge bg-success">${queue.visibleMessages} Visible</span>
                                </div>
                                <div class="col-6">
                                    <span class="badge bg-warning">${queue.totalMessages - queue.visibleMessages} Invisible</span>
                                </div>
                            </div>
                            <small class="text-muted">Total: ${queue.totalMessages} messages</small>
                        `;
                        
                        visibilityInfo.innerHTML = `
                            <div class="alert alert-info">
                                <strong>${queue.visibilityTimeout} seconds</strong><br>
                                <small>Messages become invisible for this duration when received</small>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error updating queue status:', error);
            }
        }

        function hideMessagesSection() {
            currentQueueId = null;
            currentQueueName = null;
            document.getElementById('messagesSection').style.display = 'none';
        }

        async function addMessage() {
            const content = document.getElementById('messageContent').value;
            
            if (!content.trim()) {
                showAlert('Please enter message content', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/uws-sqs/queues/${currentQueueId}/messages`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ content: content })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Message sent successfully! Click "Peek Messages" to view it.');
                    document.getElementById('messageContent').value = '';
                    // Don't automatically load messages - user must click "Peek Messages"
                    // loadMessages(false);
                } else {
                    showAlert(data.error || 'Failed to send message', 'danger');
                }
            } catch (error) {
                showAlert('Error sending message: ' + error.message, 'danger');
            }
        }

        async function loadMessages(receive = false) {
            const messagesList = document.getElementById('messagesList');
            messagesList.style.display = 'block';
            messagesList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

            try {
                const url = `/api/uws-sqs/queues/${currentQueueId}/messages?receive=${receive}&maxMessages=10`;
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayMessages(data.messages);
                    
                    // Update queue status after operation
                    if (currentQueueId && currentQueueName) {
                        updateQueueStatus(currentQueueId, currentQueueName);
                    }
                    
                    // Show operation feedback
                    if (receive) {
                        if (data.messages.length > 0) {
                            showAlert(`Received ${data.messages.length} message(s). They are now invisible for 30 seconds.`);
                        } else {
                            showAlert('No visible messages to receive. Try again later.');
                        }
                    } else {
                        if (data.messages.length > 0) {
                            showAlert(`Found ${data.messages.length} visible message(s) in the queue.`);
                        } else {
                            showAlert('No visible messages in the queue.');
                        }
                    }
                } else {
                    showAlert(data.error || 'Failed to load messages', 'danger');
                }
            } catch (error) {
                showAlert('Error loading messages: ' + error.message, 'danger');
            }
        }

        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                messagesList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>No messages in this queue.</p></div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Content</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            messages.forEach(message => {
                const createdAt = new Date(message.createdAt).toLocaleString();
                const statusBadge = getStatusBadge(message.status, message.isVisible, message.isCurrentlyInvisible, message.hasExpiredVisibility);
                const contentPreview = message.content.length > 50 ? message.content.substring(0, 50) + '...' : message.content;
                
                // Don't show delete button for already deleted messages
                const actionButtons = message.status === 'DELETED' ? 
                    `<button class="btn btn-info btn-sm" onclick="viewMessage(${JSON.stringify(message).replace(/"/g, '&quot;')})">
                        <i class="fas fa-eye"></i> View
                    </button>` :
                    `<button class="btn btn-info btn-sm me-1" onclick="viewMessage(${JSON.stringify(message).replace(/"/g, '&quot;')})">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteMessage(${message.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>`;
                
                html += `
                    <tr>
                        <td><code>${message.id}</code></td>
                        <td>
                            <div class="message-content" title="${message.content}">${contentPreview}</div>
                        </td>
                        <td>${statusBadge}</td>
                        <td>${createdAt}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            messagesList.innerHTML = html;
        }

        function getStatusBadge(status, isVisible, isCurrentlyInvisible, hasExpiredVisibility) {
            if (status === 'DELETED') {
                return '<span class="badge bg-danger">Deleted</span>';
            } else if (status === 'INVISIBLE') {
                if (hasExpiredVisibility) {
                    return '<span class="badge bg-info">Expired (Will be visible soon)</span>';
                } else {
                    return '<span class="badge bg-warning">Invisible</span>';
                }
            } else if (status === 'VISIBLE') {
                return '<span class="badge bg-success">Visible</span>';
            } else {
                return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        function viewMessage(message) {
            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            const messageDetails = document.getElementById('messageDetails');
            
            const createdAt = new Date(message.createdAt).toLocaleString();
            const visibilityExpiry = message.visibilityExpiry ? new Date(message.visibilityExpiry).toLocaleString() : 'N/A';
            
            messageDetails.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Message ID:</strong> <code>${message.id}</code></p>
                        <p><strong>Status:</strong> ${getStatusBadge(message.status, message.isVisible, message.isCurrentlyInvisible, message.hasExpiredVisibility)}</p>
                        <p><strong>Created:</strong> ${createdAt}</p>
                        <p><strong>Visibility Expiry:</strong> ${visibilityExpiry}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Content:</strong></p>
                        <div class="bg-light p-3 rounded">
                            <pre style="white-space: pre-wrap; word-wrap: break-word;">${message.content}</pre>
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
        }

        async function deleteMessage(messageId) {
            console.log('deleteMessage called with messageId:', messageId);
            console.log('currentQueueId:', currentQueueId);
            
            if (!confirm('Are you sure you want to delete this message?')) {
                console.log('User cancelled delete');
                return;
            }

            try {
                console.log('Sending DELETE request to:', `/api/uws-sqs/queues/${currentQueueId}/messages/${messageId}`);
                
                const response = await fetch(`/api/uws-sqs/queues/${currentQueueId}/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    showAlert('Message deleted successfully!');
                    // Refresh the message list to show the updated state
                    loadMessages(false);
                } else {
                    showAlert(data.error || 'Failed to delete message', 'danger');
                }
            } catch (error) {
                console.error('Error in deleteMessage:', error);
                showAlert('Error deleting message: ' + error.message, 'danger');
            }
        }

        function logout() {
            localStorage.removeItem('jwtToken');
            alert('Logged out successfully!');
            window.location.href = '/index.html';
        }

        // Auto-refresh messages every 30 seconds when viewing a queue
        // Disabled to require explicit user action
        /*
        setInterval(() => {
            if (currentQueueId) {
                loadMessages(false);
            }
        }, 30000);
        */

        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });

            // Set active nav link based on current page
            const currentPage = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html> 
