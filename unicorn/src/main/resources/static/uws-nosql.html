<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unicorn - UWS-NoSQL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
        }

        /* Headings - Montserrat */
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        /* Brand title and subtitle - Montserrat */
        .brand-title, .brand-subtitle {
            font-family: 'Montserrat', sans-serif;
        }

        /* Navigation links - Poppins */
        .nav-link {
            font-family: 'Poppins', sans-serif;
        }

        /* Button text - Poppins */
        .btn {
            font-family: 'Poppins', sans-serif;
        }

        /* Table headers - Montserrat */
        .table th {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        /* Modal titles - Montserrat */
        .modal-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        /* Form labels - Montserrat */
        .form-label {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            gap: 0.5rem;
        }
        
        .brand-logo {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .brand-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .brand-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #4a4afb;
            line-height: 1;
            letter-spacing: 0.5px;
        }
        
        .brand-subtitle {
            font-size: 0.7rem;
            font-weight: bold;
            color: #4a4afb;
            line-height: 1;
            letter-spacing: 0.3px;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #495057;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-link i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
        }

        .top-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar-toggle {
                display: block !important;
            }
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }
        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
        }
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 10px;
        }
        .btn-danger:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
            transform: translateY(-2px);
        }
        .json-editor {
            font-family: 'Courier New', monospace;
            min-height: 200px;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .entity-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        .stats-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard.html" class="sidebar-brand">
                <img src="/unicornicon.png?v=1" alt="Unicorn Logo" class="brand-logo">
                <div class="brand-text">
                    <div class="brand-title">UNICORN</div>
                    <div class="brand-subtitle">WEB SERVICES</div>
                </div>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="/dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-billing.html" class="nav-link">
                    <i class="fas fa-credit-card"></i>
                    UWS-Billing
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-monitoring.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    UWS-Monitoring
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-s3.html" class="nav-link">
                    <i class="fas fa-cloud"></i>
                    UWS-S3
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-compute.html" class="nav-link">
                    <i class="fas fa-server"></i>
                    UWS-Compute
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-lambda.html" class="nav-link">
                    <i class="fas fa-code"></i>
                    UWS-Lambda
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-rdb.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-RDB
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-sqs.html" class="nav-link">
                    <i class="fas fa-envelope-open-text"></i>
                    UWS-SQS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-nosql.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-NoSQL
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-ai.html" class="nav-link">
                    <i class="fas fa-brain"></i>
                    UWS-AI
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-secrets.html" class="nav-link">
                    <i class="fas fa-key"></i>
                    UWS-Secrets
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-dns.html" class="nav-link">
                    <i class="fas fa-globe"></i>
                    UWS-DNS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-iam.html" class="nav-link">
                    <i class="fas fa-users-cog"></i>
                    UWS-IAM
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="sidebar-toggle me-3" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0">UWS-NoSQL Document Database</h4>
            </div>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>

        <div class="container">
        <div class="main-card">
            <div class="text-center mb-4">
                <h1><i class="fas fa-database"></i> UWS-NoSQL Document Database</h1>
                <p class="lead">Create and manage NoSQL-style document tables with flexible JSON schema</p>
            </div>

            <!-- Table Management Section -->
            <div class="feature-card">
                <h4><i class="fas fa-table"></i> Table Management</h4>
                <div class="row">
                    <div class="col-md-6">
                        <form id="createTableForm">
                            <div class="mb-3">
                                <label for="tableName" class="form-label">Table Name</label>
                                <input type="text" class="form-control" id="tableName" required>
                            </div>
                            <div class="mb-3">
                                <label for="primaryKey" class="form-label">Primary Key Field</label>
                                <input type="text" class="form-control" id="primaryKey" required>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description (Optional)</label>
                                <textarea class="form-control" id="description" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Table
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h6>Your Tables</h6>
                        <div id="tablesList" class="table-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading tables...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Index Management Section -->
            <div class="feature-card">
                <h4><i class="fas fa-search"></i> Index Management</h4>
                <div class="row">
                    <div class="col-md-6">
                        <form id="createIndexForm">
                            <div class="mb-3">
                                <label for="indexName" class="form-label">Index Name</label>
                                <input type="text" class="form-control" id="indexName" required>
                            </div>
                            <div class="mb-3">
                                <label for="indexField" class="form-label">Field to Index</label>
                                <input type="text" class="form-control" id="indexField" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Index
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h6>Table Indexes</h6>
                        <div id="indexesList" class="table-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle"></i> Select a table to view indexes
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entity Operations Section -->
            <div class="feature-card">
                <h4><i class="fas fa-file-alt"></i> Entity Operations</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="selectedTable" class="form-label">Select Table</label>
                            <select class="form-select" id="selectedTable" onchange="loadTableStats()">
                                <option value="">Choose a table...</option>
                            </select>
                        </div>
                        <div id="tableStats" class="mb-3"></div>
                        
                        <form id="entityForm">
                            <div class="mb-3">
                                <label for="entityData" class="form-label">Entity Data (JSON)</label>
                                <textarea class="form-control json-editor" id="entityData" rows="8" placeholder='{
  "id": "123",
  "name": "Sample Product",
  "category": "electronics",
  "price": 99.99
}'></textarea>
                            </div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" onclick="insertEntity()">
                                    <i class="fas fa-plus"></i> Insert
                                </button>
                                <button type="button" class="btn btn-warning" onclick="updateEntity()">
                                    <i class="fas fa-edit"></i> Update
                                </button>
                                <button type="button" class="btn btn-danger" onclick="deleteEntity()">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h6>Query & Scan</h6>
                        <div class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="queryField" placeholder="Field name">
                                <input type="text" class="form-control" id="queryValue" placeholder="Field value">
                                <button class="btn btn-outline-primary" onclick="queryEntities()">
                                    <i class="fas fa-search"></i> Query
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="input-group">
                                <input type="number" class="form-control" id="pageSize" value="10" min="1" max="100">
                                <button class="btn btn-outline-secondary" onclick="scanTable()">
                                    <i class="fas fa-list"></i> Scan Table
                                </button>
                            </div>
                        </div>
                        <div id="entitiesList" class="table-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle"></i> Select a table and scan or query to see entities
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="feature-card">
                <h4><i class="fas fa-chart-bar"></i> Results & Statistics</h4>
                <div id="resultsContainer">
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line"></i> Operations will appear here
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTableId = null;
        let currentPage = 0;

        // Check authentication on page load
        window.addEventListener('load', function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            loadTables();
        });

        // Load all tables for the current user
        async function loadTables() {
            try {
                const response = await fetch('/api/nosql/tables', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });
                
                if (response.ok) {
                    const tables = await response.json();
                    displayTables(tables);
                    updateTableSelect(tables);
                } else {
                    showResult('Error loading tables: ' + response.statusText, 'danger');
                }
            } catch (error) {
                showResult('Error loading tables: ' + error.message, 'danger');
            }
        }

        // Display tables in the list
        function displayTables(tables) {
            const tablesList = document.getElementById('tablesList');
            if (tables.length === 0) {
                tablesList.innerHTML = '<div class="text-center text-muted">No tables created yet</div>';
                return;
            }

            tablesList.innerHTML = tables.map(table => `
                <div class="entity-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${table.name}</h6>
                            <small class="text-muted">Primary Key: ${table.primaryKey}</small>
                            ${table.description ? `<br><small class="text-muted">${table.description}</small>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectTable(${table.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTable(${table.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update table select dropdown
        function updateTableSelect(tables) {
            const select = document.getElementById('selectedTable');
            select.innerHTML = '<option value="">Choose a table...</option>';
            tables.forEach(table => {
                select.innerHTML += `<option value="${table.id}">${table.name}</option>`;
            });
        }

        // Create new table
        document.getElementById('createTableForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tableData = {
                name: document.getElementById('tableName').value,
                primaryKey: document.getElementById('primaryKey').value,
                description: document.getElementById('description').value
            };

            try {
                const response = await fetch('/api/nosql/tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(tableData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`Table "${result.name}" created successfully!`, 'success');
                    document.getElementById('createTableForm').reset();
                    loadTables();
                } else {
                    const error = await response.text();
                    showResult('Error creating table: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error creating table: ' + error.message, 'danger');
            }
        });

        // Select table for operations
        function selectTable(tableId) {
            currentTableId = tableId;
            document.getElementById('selectedTable').value = tableId;
            loadTableStats();
            scanTable();
        }

        // Load table statistics
        async function loadTableStats() {
            const tableId = document.getElementById('selectedTable').value;
            if (!tableId) {
                document.getElementById('tableStats').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/api/nosql/tables/${tableId}/stats`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('tableStats').innerHTML = `
                        <div class="stats-badge">
                            <i class="fas fa-chart-bar"></i> ${stats.entityCount} entities
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading table stats:', error);
            }
        }

        // Insert entity
        async function insertEntity() {
            if (!currentTableId) {
                showResult('Please select a table first', 'warning');
                return;
            }

            try {
                const entityData = JSON.parse(document.getElementById('entityData').value);
                
                const response = await fetch(`/api/nosql/tables/${currentTableId}/entity`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(entityData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`Entity inserted successfully! Primary Key: ${result.primaryKeyValue}`, 'success');
                    document.getElementById('entityData').value = '';
                    loadTableStats();
                    scanTable();
                } else {
                    const error = await response.text();
                    showResult('Error inserting entity: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error inserting entity: ' + error.message, 'danger');
            }
        }

        // Update entity
        async function updateEntity() {
            if (!currentTableId) {
                showResult('Please select a table first', 'warning');
                return;
            }

            try {
                const entityData = JSON.parse(document.getElementById('entityData').value);
                
                const response = await fetch(`/api/nosql/tables/${currentTableId}/entity`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(entityData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`Entity updated successfully! Primary Key: ${result.primaryKeyValue}`, 'success');
                    document.getElementById('entityData').value = '';
                    scanTable();
                } else {
                    const error = await response.text();
                    showResult('Error updating entity: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error updating entity: ' + error.message, 'danger');
            }
        }

        // Delete entity
        async function deleteEntity() {
            if (!currentTableId) {
                showResult('Please select a table first', 'warning');
                return;
            }

            if (!confirm('Are you sure you want to delete this entity?')) {
                return;
            }

            try {
                const entityData = JSON.parse(document.getElementById('entityData').value);
                
                const response = await fetch(`/api/nosql/tables/${currentTableId}/entity`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(entityData)
                });

                if (response.ok) {
                    showResult('Entity deleted successfully!', 'success');
                    document.getElementById('entityData').value = '';
                    loadTableStats();
                    scanTable();
                } else {
                    const error = await response.text();
                    showResult('Error deleting entity: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error deleting entity: ' + error.message, 'danger');
            }
        }

        // Scan table
        async function scanTable() {
            if (!currentTableId) {
                showResult('Please select a table first', 'warning');
                return;
            }

            const pageSize = document.getElementById('pageSize').value || 10;
            
            try {
                const response = await fetch(`/api/nosql/tables/${currentTableId}/scan?page=${currentPage}&size=${pageSize}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    displayEntities(result.entities, result.totalCount, currentPage, pageSize);
                } else {
                    const error = await response.text();
                    showResult('Error scanning table: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error scanning table: ' + error.message, 'danger');
            }
        }

        // Query entities
        async function queryEntities() {
            if (!currentTableId) {
                showResult('Please select a table first', 'warning');
                return;
            }

            const field = document.getElementById('queryField').value;
            const value = document.getElementById('queryValue').value;

            if (!field || !value) {
                showResult('Please provide both field name and value', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/nosql/tables/${currentTableId}/query?field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    displayEntities(result.entities, result.count, 0, result.count);
                    showResult(`Found ${result.count} entities matching query`, 'info');
                } else {
                    const error = await response.text();
                    showResult('Error querying entities: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error querying entities: ' + error.message, 'danger');
            }
        }

        // Display entities
        function displayEntities(entities, totalCount, page, pageSize) {
            const entitiesList = document.getElementById('entitiesList');
            
            if (entities.length === 0) {
                entitiesList.innerHTML = '<div class="text-center text-muted">No entities found</div>';
                return;
            }

            let html = `<div class="mb-3">
                <small class="text-muted">Showing ${entities.length} of ${totalCount} entities</small>
            </div>`;

            entities.forEach(entity => {
                try {
                    const data = JSON.parse(entity.documentData);
                    html += `
                        <div class="entity-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-2">Primary Key: ${entity.primaryKeyValue}</h6>
                                    <pre class="mb-2" style="font-size: 0.8rem; background: #f8f9fa; padding: 0.5rem; border-radius: 5px;">${JSON.stringify(data, null, 2)}</pre>
                                    <small class="text-muted">Created: ${new Date(entity.createdAt).toLocaleString()}</small>
                                </div>
                                <div class="ms-2">
                                    <button class="btn btn-sm btn-outline-primary edit-entity-btn" 
                                            data-primary-key="${entity.primaryKeyValue}" 
                                            data-document="${encodeURIComponent(entity.documentData)}"
                                            title="Edit this entity">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div class="entity-card">
                            <div class="text-danger">Error parsing entity data</div>
                        </div>
                    `;
                }
            });

            // Add pagination if needed
            if (totalCount > pageSize) {
                const totalPages = Math.ceil(totalCount / pageSize);
                html += `
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(${page - 1})" ${page === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span class="text-muted">Page ${page + 1} of ${totalPages}</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(${page + 1})" ${page >= totalPages - 1 ? 'disabled' : ''}>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                `;
            }

            entitiesList.innerHTML = html;
            
            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-entity-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const primaryKey = this.getAttribute('data-primary-key');
                    const documentData = decodeURIComponent(this.getAttribute('data-document'));
                    loadEntityForEdit(primaryKey, documentData);
                });
            });
        }

        // Change page for pagination
        function changePage(newPage) {
            currentPage = newPage;
            scanTable();
        }

        // Load entity for editing
        function loadEntityForEdit(primaryKeyValue, documentData) {
            document.getElementById('entityData').value = documentData;
            showResult(`Loaded entity with primary key: ${primaryKeyValue} for editing. You can now modify the data and click "Update" to save changes.`, 'info');
            
            // Scroll to the form
            document.getElementById('entityData').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Focus on the textarea
            document.getElementById('entityData').focus();
        }

        // Delete table
        async function deleteTable(tableId) {
            if (!confirm('Are you sure you want to delete this table and all its entities? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/nosql/tables/${tableId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    showResult('Table deleted successfully!', 'success');
                    if (currentTableId === tableId) {
                        currentTableId = null;
                        document.getElementById('selectedTable').value = '';
                        document.getElementById('tableStats').innerHTML = '';
                        document.getElementById('entitiesList').innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle"></i> Select a table and scan or query to see entities</div>';
                    }
                    loadTables();
                } else {
                    const error = await response.text();
                    showResult('Error deleting table: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error deleting table: ' + error.message, 'danger');
            }
        }

        // Show result message
        function showResult(message, type) {
            const resultsContainer = document.getElementById('resultsContainer');
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'danger' ? 'alert-danger' : 
                             type === 'warning' ? 'alert-warning' : 'alert-info';
            
            resultsContainer.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/index.html';
        }

        // Handle table selection change
        document.getElementById('selectedTable').addEventListener('change', function() {
            currentTableId = this.value;
            currentPage = 0;
            if (currentTableId) {
                loadTableStats();
                loadIndexes();
                scanTable();
            } else {
                document.getElementById('tableStats').innerHTML = '';
                document.getElementById('entitiesList').innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle"></i> Select a table and scan or query to see entities</div>';
                document.getElementById('indexesList').innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle"></i> Select a table to view indexes</div>';
            }
        });

        // Create index form handler
        document.getElementById('createIndexForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentTableId) {
                showResult('Please select a table first', 'warning');
                return;
            }

            const indexData = {
                indexName: document.getElementById('indexName').value,
                fieldName: document.getElementById('indexField').value
            };

            try {
                const response = await fetch(`/api/nosql/tables/${currentTableId}/indexes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(indexData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`Index "${result.indexName}" created successfully for field "${result.fieldName}"!`, 'success');
                    document.getElementById('createIndexForm').reset();
                    loadIndexes();
                } else {
                    const error = await response.text();
                    showResult('Error creating index: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error creating index: ' + error.message, 'danger');
            }
        });

        // Load indexes for current table
        async function loadIndexes() {
            if (!currentTableId) return;

            try {
                const response = await fetch(`/api/nosql/tables/${currentTableId}/indexes`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });
                
                if (response.ok) {
                    const indexes = await response.json();
                    displayIndexes(indexes);
                } else {
                    showResult('Error loading indexes: ' + response.statusText, 'danger');
                }
            } catch (error) {
                showResult('Error loading indexes: ' + error.message, 'danger');
            }
        }

        // Display indexes
        function displayIndexes(indexes) {
            const indexesList = document.getElementById('indexesList');
            
            if (indexes.length === 0) {
                indexesList.innerHTML = '<div class="text-center text-muted">No indexes created yet</div>';
                return;
            }

            indexesList.innerHTML = indexes.map(index => `
                <div class="entity-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${index.indexName}</h6>
                            <small class="text-muted">Field: ${index.fieldName}</small><br>
                            <small class="text-muted">Type: ${index.indexType}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIndex(${index.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Delete index
        async function deleteIndex(indexId) {
            if (!confirm('Are you sure you want to delete this index?')) {
                return;
            }

            try {
                const response = await fetch(`/api/nosql/tables/${currentTableId}/indexes/${indexId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    showResult('Index deleted successfully!', 'success');
                    loadIndexes();
                } else {
                    const error = await response.text();
                    showResult('Error deleting index: ' + error, 'danger');
                }
            } catch (error) {
                showResult('Error deleting index: ' + error.message, 'danger');
            }
        }

        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });

            // Set active nav link based on current page
            const currentPage = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/login.html';
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 