<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unicorn - UWS-RDB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #495057;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-link i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
        }

        .top-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar-toggle {
                display: block !important;
            }
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .header-section {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .card-header {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-bottom: none;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
        }
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
        }
        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .instance-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .instance-card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .status-running {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
        }
        .status-creating {
            background: linear-gradient(45deg, #ffd43b, #fcc419);
            color: #212529;
        }
        .status-stopped {
            background: linear-gradient(45deg, #868e96, #6c757d);
            color: white;
        }
        .status-error {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }
        .sql-editor {
            border-radius: 10px;
            overflow: hidden;
        }
        .CodeMirror {
            height: 200px;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 14px;
        }
        .results-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .table {
            margin-bottom: 0;
        }
        .table th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: none;
            font-weight: 600;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .loading-spinner {
            display: none;
        }
        .resource-info {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .resource-info h6 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard.html" class="sidebar-brand">ðŸ¦„ Unicorn</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="/dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-billing.html" class="nav-link">
                    <i class="fas fa-credit-card"></i>
                    UWS-Billing
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-monitoring.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    UWS-Monitoring
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-s3.html" class="nav-link">
                    <i class="fas fa-cloud"></i>
                    UWS-S3
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-compute.html" class="nav-link">
                    <i class="fas fa-server"></i>
                    UWS-Compute
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-lambda.html" class="nav-link">
                    <i class="fas fa-code"></i>
                    UWS-Lambda
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-rdb.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-RDB
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-sqs.html" class="nav-link">
                    <i class="fas fa-envelope-open-text"></i>
                    UWS-SQS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-nosql.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-NoSQL
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-ai.html" class="nav-link">
                    <i class="fas fa-brain"></i>
                    UWS-AI
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-secrets.html" class="nav-link">
                    <i class="fas fa-key"></i>
                    UWS-Secrets
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-dns.html" class="nav-link">
                    <i class="fas fa-globe"></i>
                    UWS-DNS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-iam.html" class="nav-link">
                    <i class="fas fa-users-cog"></i>
                    UWS-IAM
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="sidebar-toggle me-3" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0">UWS-RDB Relational Database</h4>
            </div>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>

        <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section">
                <h1><i class="fas fa-database"></i> UWS-RDB</h1>
                <p class="lead mb-0">Relational Database Service - Create, manage, and query your database instances</p>
            </div>

            <!-- Create Database Instance -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-plus-circle"></i> Create New Database Instance</h5>
                </div>
                <div class="card-body">
                    <form id="createInstanceForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dbName" class="form-label">Database Name</label>
                                    <input type="text" class="form-control" id="dbName" required 
                                           placeholder="Enter database name (e.g., myapp_db)">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cpuLimit" class="form-label">CPU Limit (cores)</label>
                                    <select class="form-select" id="cpuLimit" required>
                                        <option value="">Select CPU cores</option>
                                        <option value="1">1 Core</option>
                                        <option value="2">2 Cores</option>
                                        <option value="4">4 Cores</option>
                                        <option value="8">8 Cores</option>
                                        <option value="16">16 Cores</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ramLimit" class="form-label">RAM Limit (MB)</label>
                                    <select class="form-select" id="ramLimit" required>
                                        <option value="">Select RAM</option>
                                        <option value="512">512 MB</option>
                                        <option value="1024">1 GB</option>
                                        <option value="2048">2 GB</option>
                                        <option value="4096">4 GB</option>
                                        <option value="8192">8 GB</option>
                                        <option value="16384">16 GB</option>
                                        <option value="32768">32 GB</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="storageLimit" class="form-label">Storage Limit (MB)</label>
                                    <select class="form-select" id="storageLimit" required>
                                        <option value="">Select Storage</option>
                                        <option value="1024">1 GB</option>
                                        <option value="5120">5 GB</option>
                                        <option value="10240">10 GB</option>
                                        <option value="51200">50 GB</option>
                                        <option value="102400">100 GB</option>
                                        <option value="512000">500 GB</option>
                                        <option value="1048576">1 TB</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Database Instance
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Database Instances List -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-database"></i> Database Instances</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshInstances()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="instancesList">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Monitoring Dashboard -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Database Monitoring</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6><i class="fas fa-server"></i> Instance Statistics</h6>
                                    <div id="instanceStats">
                                        <p class="text-muted">Select an instance to view statistics</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6><i class="fas fa-tachometer-alt"></i> Performance Metrics</h6>
                                    <div id="performanceMetrics">
                                        <p class="text-muted">Select an instance to view performance</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup & Restore Section -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> Backup & Restore</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="backupInstanceSelect" class="form-label">Select Database Instance for Backup/Restore</label>
                            <select class="form-select" id="backupInstanceSelect">
                                <option value="">Select Database Instance</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6><i class="fas fa-download"></i> Create Backup</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">Create a complete backup of your database instance</p>
                                    <button class="btn btn-primary" onclick="createBackup()">
                                        <i class="fas fa-download"></i> Create Backup
                                    </button>
                                    <div id="backupResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6><i class="fas fa-upload"></i> Restore Backup</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">Restore your database from a backup file</p>
                                    <input type="file" class="form-control mb-3" id="backupFile" accept=".json">
                                    <button class="btn btn-success" onclick="restoreBackup()">
                                        <i class="fas fa-upload"></i> Restore Backup
                                    </button>
                                    <div id="restoreResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SQL Query Editor -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-code"></i> SQL Query Editor</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select" id="instanceSelect">
                                <option value="">Select Database Instance</option>
                            </select>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-success" onclick="executeQuery()">
                                <i class="fas fa-play"></i> Execute Query
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearEditor()">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                    </div>
                    <textarea id="sqlEditor" placeholder="Enter your SQL query here..."></textarea>
                    <div id="queryResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>

    <script>
        let codeMirror;
        let instances = [];
        let currentBackup = null;

        // Initialize CodeMirror for SQL editor
        document.addEventListener('DOMContentLoaded', function() {
            codeMirror = CodeMirror.fromTextArea(document.getElementById('sqlEditor'), {
                mode: 'text/x-sql',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                lineWrapping: true
            });

            // Check authentication and load data
            checkAuth();
            loadInstances();
            updateBackupInstanceSelect(); // Initialize backup instance select
        });

        function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
        }

        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/index.html';
        }

        // Create database instance
        document.getElementById('createInstanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                dbName: document.getElementById('dbName').value,
                cpuLimit: parseInt(document.getElementById('cpuLimit').value),
                ramLimit: parseInt(document.getElementById('ramLimit').value),
                storageLimit: parseInt(document.getElementById('storageLimit').value)
            };

            createInstance(formData);
        });

        async function createInstance(data) {
            try {
                showLoading();
                const response = await fetch('/api/uws-rdb/instances', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('Database instance created successfully!', 'success');
                    document.getElementById('createInstanceForm').reset();
                    loadInstances();
                    updateBackupInstanceSelect(); // Update backup instance select after creating new instance
                } else {
                    showAlert(result.error || 'Failed to create database instance', 'danger');
                }
            } catch (error) {
                console.error('Create instance error:', error);
                showAlert('Error creating database instance: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        // Load database instances
        async function loadInstances() {
            try {
                const response = await fetch('/api/uws-rdb/instances', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    instances = result.instances || [];
                    displayInstances();
                    updateInstanceSelect();
                    updateBackupInstanceSelect(); // Update backup instance select after loading instances
                } else {
                    showAlert(result.error || 'Failed to load instances', 'danger');
                }
            } catch (error) {
                console.error('Load instances error:', error);
                showAlert('Error loading instances: ' + error.message, 'danger');
            }
        }

        function displayInstances() {
            const container = document.getElementById('instancesList');
            
            if (instances.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No database instances found. Create your first instance above.</p>';
                return;
            }

            let html = '<div class="row">';
            instances.forEach(instance => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-database"></i> ${instance.dbName}</h6>
                                <span class="badge bg-light text-dark">${instance.status}</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">CPU Limit</small>
                                        <p class="mb-1"><strong>${instance.cpuLimit} cores</strong></p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">RAM Limit</small>
                                        <p class="mb-1"><strong>${instance.ramLimit} MB</strong></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Storage Limit</small>
                                        <p class="mb-1"><strong>${formatStorageSize(instance.storageLimit)}</strong></p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Created</small>
                                        <p class="mb-1"><strong>${new Date(instance.createdAt).toLocaleDateString()}</strong></p>
                                    </div>
                                </div>
                                <div class="btn-group w-100 mt-2" role="group">
                                    <button class="btn btn-sm btn-outline-info" onclick="loadInstanceStats(${instance.id})">
                                        <i class="fas fa-chart-bar"></i> Stats
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="loadPerformanceMetrics(${instance.id})">
                                        <i class="fas fa-tachometer-alt"></i> Performance
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteInstance(${instance.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function updateInstanceSelect() {
            const select = document.getElementById('instanceSelect');
            select.innerHTML = '<option value="">Select Database Instance</option>';
            instances.forEach(instance => {
                select.innerHTML += `<option value="${instance.id}">${instance.dbName}</option>`;
            });
        }

        function updateBackupInstanceSelect() {
            const select = document.getElementById('backupInstanceSelect');
            select.innerHTML = '<option value="">Select Database Instance</option>';
            instances.forEach(instance => {
                select.innerHTML += `<option value="${instance.id}">${instance.dbName}</option>`;
            });
        }

        function formatStorageSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        async function deleteInstance(instanceId) {
            if (!confirm('Are you sure you want to delete this database instance? This action cannot be undone.')) {
                return;
            }

            try {
                showLoading();
                const response = await fetch(`/api/uws-rdb/instances/${instanceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('Database instance deleted successfully!', 'success');
                    loadInstances();
                    updateBackupInstanceSelect(); // Update backup instance select after deleting instance
                } else {
                    showAlert(result.error || 'Failed to delete instance', 'danger');
                }
            } catch (error) {
                console.error('Delete instance error:', error);
                showAlert('Error deleting instance: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function refreshInstances() {
            loadInstances();
        }

        // NEW FEATURES

        // Load instance statistics
        async function loadInstanceStats(instanceId) {
            try {
                const response = await fetch(`/api/uws-rdb/instances/${instanceId}/stats`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const stats = result.stats;
                    const container = document.getElementById('instanceStats');
                    container.innerHTML = `
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">${stats.tableCount}</h4>
                                <small class="text-muted">Tables</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success">${stats.totalRows}</h4>
                                <small class="text-muted">Total Rows</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Storage Used</small>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${(stats.estimatedStorageUsed / stats.storageLimit) * 100}%">
                                    ${formatStorageSize(stats.estimatedStorageUsed)} / ${formatStorageSize(stats.storageLimit)}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    showAlert(result.error || 'Failed to load statistics', 'danger');
                }
            } catch (error) {
                console.error('Load stats error:', error);
                showAlert('Error loading statistics: ' + error.message, 'danger');
            }
        }

        // Load performance metrics
        async function loadPerformanceMetrics(instanceId) {
            try {
                const response = await fetch(`/api/uws-rdb/instances/${instanceId}/performance`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const metrics = result.performance;
                    const container = document.getElementById('performanceMetrics');
                    container.innerHTML = `
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-warning">${metrics.cpuUsage.toFixed(1)}%</h4>
                                <small class="text-muted">CPU Usage</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info">${metrics.memoryUsage.toFixed(1)}%</h4>
                                <small class="text-muted">Memory Usage</small>
                            </div>
                        </div>
                        <div class="row text-center mt-2">
                            <div class="col-6">
                                <h4 class="text-success">${metrics.queriesPerSecond.toFixed(1)}</h4>
                                <small class="text-muted">Queries/sec</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-primary">${metrics.averageQueryTime.toFixed(0)}ms</h4>
                                <small class="text-muted">Avg Query Time</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Active Connections: ${metrics.activeConnections}</small><br>
                            <small class="text-muted">Uptime: ${metrics.uptime}</small>
                        </div>
                    `;
                } else {
                    showAlert(result.error || 'Failed to load performance metrics', 'danger');
                }
            } catch (error) {
                console.error('Load performance error:', error);
                showAlert('Error loading performance metrics: ' + error.message, 'danger');
            }
        }

        // Create backup
        async function createBackup() {
            const instanceId = document.getElementById('backupInstanceSelect').value;
            if (!instanceId) {
                showAlert('Please select a database instance first', 'warning');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`/api/uws-rdb/instances/${instanceId}/backup`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentBackup = result.backup;
                    const container = document.getElementById('backupResult');
                    container.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check"></i> Backup Created Successfully!</h6>
                            <p class="mb-1">Database: ${result.backup.databaseName}</p>
                            <p class="mb-1">Tables: ${result.backup.tables.length}</p>
                            <p class="mb-2">Date: ${new Date(result.backup.backupDate).toLocaleString()}</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup()">
                                <i class="fas fa-download"></i> Download Backup
                            </button>
                        </div>
                    `;
                    showAlert('Backup created successfully!', 'success');
                } else {
                    showAlert(result.error || 'Failed to create backup', 'danger');
                }
            } catch (error) {
                console.error('Create backup error:', error);
                showAlert('Error creating backup: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        // Download backup
        function downloadBackup() {
            if (!currentBackup) {
                showAlert('No backup available to download', 'warning');
                return;
            }

            const dataStr = JSON.stringify(currentBackup, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_${currentBackup.databaseName}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Restore backup
        async function restoreBackup() {
            const instanceId = document.getElementById('backupInstanceSelect').value;
            const fileInput = document.getElementById('backupFile');
            
            if (!instanceId) {
                showAlert('Please select a database instance first', 'warning');
                return;
            }

            if (!fileInput.files[0]) {
                showAlert('Please select a backup file', 'warning');
                return;
            }

            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        showLoading();
                        const response = await fetch(`/api/uws-rdb/instances/${instanceId}/restore`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                            },
                            body: JSON.stringify(backupData)
                        });

                        const result = await response.json();
                        
                        if (response.ok) {
                            const container = document.getElementById('restoreResult');
                            container.innerHTML = `
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check"></i> Backup Restored Successfully!</h6>
                                    <p class="mb-1">Tables restored: ${result.restoredTables}</p>
                                    <p class="mb-0">Rows restored: ${result.restoredRows}</p>
                                </div>
                            `;
                            showAlert('Backup restored successfully!', 'success');
                            fileInput.value = '';
                        } else {
                            showAlert(result.error || 'Failed to restore backup', 'danger');
                        }
                    } catch (error) {
                        showAlert('Invalid backup file format', 'danger');
                    } finally {
                        hideLoading();
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('Restore backup error:', error);
                showAlert('Error restoring backup: ' + error.message, 'danger');
            }
        }

        // Execute SQL query
        async function executeQuery() {
            const instanceId = document.getElementById('instanceSelect').value;
            const sql = codeMirror.getValue().trim();

            if (!instanceId) {
                showAlert('Please select a database instance', 'warning');
                return;
            }

            if (!sql) {
                showAlert('Please enter a SQL query', 'warning');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`/api/uws-rdb/instances/${instanceId}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify({ sql: sql })
                });

                const result = await response.json();

                if (response.ok) {
                    displayQueryResult(result);
                    showAlert('Query executed successfully!', 'success');
                    // Clear the editor after successful execution to prevent concatenation
                    codeMirror.setValue('');
                } else {
                    showAlert(result.error || 'Failed to execute query', 'danger');
                }
            } catch (error) {
                console.error('Execute query error:', error);
                showAlert('Error executing query: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function displayQueryResult(result) {
            const container = document.getElementById('queryResult');
            const queryResult = result.result;

            let html = '<div class="alert alert-success">';
            html += `<h6><i class="fas fa-check"></i> Query Executed Successfully</h6>`;
            html += `<p><strong>Operation:</strong> ${queryResult.operation}</p>`;
            
            if (queryResult.affectedRows !== undefined) {
                html += `<p><strong>Affected Rows:</strong> ${queryResult.affectedRows}</p>`;
            }

            if (queryResult.data && queryResult.data.length > 0) {
                html += '<div class="table-responsive mt-3">';
                html += '<table class="table table-sm table-striped">';
                
                // Table header
                html += '<thead><tr>';
                Object.keys(queryResult.data[0]).forEach(key => {
                    html += `<th>${key}</th>`;
                });
                html += '</tr></thead>';
                
                // Table body
                html += '<tbody>';
                queryResult.data.forEach(row => {
                    html += '<tr>';
                    Object.values(row).forEach(value => {
                        html += `<td>${value !== null ? value : '<em>null</em>'}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function clearEditor() {
            if (codeMirror.getValue().trim()) {
                if (confirm('Are you sure you want to clear the SQL editor?')) {
                    codeMirror.setValue('');
                    document.getElementById('queryResult').innerHTML = '';
                }
            } else {
                codeMirror.setValue('');
                document.getElementById('queryResult').innerHTML = '';
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });

            // Set active nav link based on current page
            const currentPage = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html> 