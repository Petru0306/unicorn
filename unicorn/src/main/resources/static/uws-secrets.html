<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWS-Secrets Manager - Unicorn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #495057;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-link i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
        }

        .top-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar-toggle {
                display: block !important;
            }
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .header-section {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 1rem;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
        }
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
        }
        .btn-danger:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
            transform: translateY(-2px);
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
        }
        .btn-success:hover {
            background: linear-gradient(45deg, #20c997, #28a745);
            transform: translateY(-2px);
        }
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
        }
        .btn-warning:hover {
            background: linear-gradient(45deg, #fd7e14, #ffc107);
            transform: translateY(-2px);
        }
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
        }
        .btn-info:hover {
            background: linear-gradient(45deg, #6f42c1, #17a2b8);
            transform: translateY(-2px);
        }
        .secret-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }
        .secret-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .secret-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .secret-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .secret-meta {
            font-size: 0.8rem;
            color: #888;
        }
        .expired-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .expiring-soon-badge {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }
        .secret-value-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(102, 126, 234, 0.1);
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            color: #667eea;
            font-size: 0.8rem;
        }
        .copy-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        .btn-logout {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            color: white;
            font-weight: 600;
        }
        .btn-logout:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
            color: white;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard.html" class="sidebar-brand">ðŸ¦„ Unicorn</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="/dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-billing.html" class="nav-link">
                    <i class="fas fa-credit-card"></i>
                    UWS-Billing
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-monitoring.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    UWS-Monitoring
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-s3.html" class="nav-link">
                    <i class="fas fa-cloud"></i>
                    UWS-S3
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-compute.html" class="nav-link">
                    <i class="fas fa-server"></i>
                    UWS-Compute
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-lambda.html" class="nav-link">
                    <i class="fas fa-code"></i>
                    UWS-Lambda
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-rdb.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-RDB
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-sqs.html" class="nav-link">
                    <i class="fas fa-envelope-open-text"></i>
                    UWS-SQS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-nosql.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-NoSQL
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-ai.html" class="nav-link">
                    <i class="fas fa-brain"></i>
                    UWS-AI
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-secrets.html" class="nav-link">
                    <i class="fas fa-key"></i>
                    UWS-Secrets
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-dns.html" class="nav-link">
                    <i class="fas fa-globe"></i>
                    UWS-DNS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-iam.html" class="nav-link">
                    <i class="fas fa-users-cog"></i>
                    UWS-IAM
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="sidebar-toggle me-3" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0">UWS-Secrets Manager</h4>
            </div>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>

        <div class="container">
        <div class="main-container">
            <!-- Header Section -->
            <div class="header-section">
                <h1><i class="fas fa-key"></i> UWS-Secrets Manager</h1>
                <p class="lead mb-0">Secure secret management with AES-256 encryption</p>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stats-card text-center">
                        <i class="fas fa-key fa-2x text-primary mb-2"></i>
                        <h4 id="totalSecrets">0</h4>
                        <p class="text-muted">Total Secrets</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card text-center">
                        <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                        <h4 id="activeSecrets">0</h4>
                        <p class="text-muted">Active Secrets</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h4 id="expiredSecrets">0</h4>
                        <p class="text-muted">Expired Secrets</p>
                    </div>
                </div>
            </div>

            <!-- Create Secret Button -->
            <div class="row mb-4">
                <div class="col-12">
                    <button class="btn btn-primary btn-lg" onclick="openCreateModal()">
                        <i class="fas fa-plus"></i> Create New Secret
                    </button>
                </div>
            </div>

            <!-- Secrets List -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-list"></i> Your Secrets</h5>
                        </div>
                        <div class="card-body">
                            <div id="loadingSpinner" class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading secrets...</p>
                            </div>
                            <div id="emptyState" class="empty-state" style="display: none;">
                                <i class="fas fa-key"></i>
                                <h4>No secrets found</h4>
                                <p>Create your first secret to get started!</p>
                                <button class="btn btn-primary" onclick="openCreateModal()">
                                    <i class="fas fa-plus"></i> Create Secret
                                </button>
                            </div>
                            <div id="secretsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Secret Modal -->
    <div class="modal fade" id="secretModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create New Secret</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="secretForm">
                        <div class="mb-3">
                            <label for="secretName" class="form-label">Secret Name *</label>
                            <input type="text" class="form-control" id="secretName" required>
                        </div>
                        <div class="mb-3">
                            <label for="secretValue" class="form-label">Secret Value *</label>
                            <textarea class="form-control" id="secretValue" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="secretDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="secretDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="secretExpiry" class="form-label">Expiration Date (Optional)</label>
                            <input type="datetime-local" class="form-control" id="secretExpiry">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSecret()">
                        <i class="fas fa-save"></i> Save Secret
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Secret Modal -->
    <div class="modal fade" id="viewSecretModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Secret Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Secret Name</label>
                        <p class="form-control-plaintext" id="viewSecretName"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Secret Value</label>
                        <div class="secret-value-display">
                            <button class="copy-btn" onclick="copyToClipboard('viewSecretValue')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <div id="viewSecretValue"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <p class="form-control-plaintext" id="viewSecretDescription"></p>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Created</label>
                            <p class="form-control-plaintext" id="viewSecretCreated"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Updated</label>
                            <p class="form-control-plaintext" id="viewSecretUpdated"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Version</label>
                            <p class="form-control-plaintext" id="viewSecretVersion"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Expires At</label>
                            <p class="form-control-plaintext" id="viewSecretExpires"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="editButtonInModal" onclick="editCurrentSecret()">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this secret? This action cannot be undone.</p>
                    <p><strong>Secret Name:</strong> <span id="deleteSecretName"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Delete Secret
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSecretId = null;
        let currentSecretData = null;
        let secretsList = [];

        // Check authentication on page load
        window.addEventListener('load', function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            loadSecrets();
            loadStats();
        });

        // Load secrets from API
        async function loadSecrets() {
            try {
                showLoading(true);
                const response = await fetch('/api/secrets', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    secretsList = data.secrets || [];
                    displaySecrets(secretsList);
                } else {
                    throw new Error('Failed to load secrets');
                }
            } catch (error) {
                console.error('Error loading secrets:', error);
                showError('Failed to load secrets: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/secrets/stats', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalSecrets').textContent = data.totalSecrets || 0;
                    document.getElementById('activeSecrets').textContent = data.activeSecrets || 0;
                    document.getElementById('expiredSecrets').textContent = data.expiredSecrets || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Display secrets in the UI
        function displaySecrets(secrets) {
            const container = document.getElementById('secretsList');
            const emptyState = document.getElementById('emptyState');

            if (secrets.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = secrets.map(secret => `
                <div class="secret-card">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="secret-name">
                                <i class="fas fa-key text-primary me-2"></i>
                                ${secret.name}
                                ${secret.isExpired ? '<span class="expired-badge ms-2">EXPIRED</span>' : ''}
                                ${isExpiringSoon(secret.expiresAt) ? '<span class="expiring-soon-badge ms-2">EXPIRING SOON</span>' : ''}
                            </div>
                            <div class="secret-description">${secret.description || 'No description'}</div>
                            <div class="secret-meta">
                                <i class="fas fa-calendar-alt me-1"></i> Created: ${formatDate(secret.createdAt)} |
                                <i class="fas fa-clock me-1"></i> Updated: ${formatDate(secret.updatedAt)} |
                                <i class="fas fa-code-branch me-1"></i> Version: ${secret.version}
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-info btn-sm me-2" onclick="viewSecret(${secret.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-warning btn-sm me-2" onclick="editSecret(${secret.id})" ${secret.isExpired ? 'disabled' : ''}>
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSecret(${secret.id}, '${secret.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Check if secret is expiring soon (within 7 days)
        function isExpiringSoon(expiresAt) {
            if (!expiresAt) return false;
            const expiryDate = new Date(expiresAt);
            const now = new Date();
            const sevenDays = 7 * 24 * 60 * 60 * 1000;
            return expiryDate > now && (expiryDate - now) <= sevenDays;
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        // Open create secret modal
        function openCreateModal() {
            currentSecretId = null;
            currentSecretData = null;
            document.getElementById('modalTitle').textContent = 'Create New Secret';
            document.getElementById('secretForm').reset();
            // Make value field required for new secrets
            document.getElementById('secretValue').required = true;
            document.getElementById('secretValue').placeholder = 'Enter secret value';
            new bootstrap.Modal(document.getElementById('secretModal')).show();
        }

        // Save secret (create or update)
        async function saveSecret() {
            try {
                const name = document.getElementById('secretName').value.trim();
                const value = document.getElementById('secretValue').value.trim();
                const description = document.getElementById('secretDescription').value.trim();
                const expiry = document.getElementById('secretExpiry').value;

                // For new secrets, both name and value are required
                if (!name) {
                    showError('Secret name is required');
                    return;
                }

                // For new secrets, value is required. For edits, it can be empty (keeps existing value)
                if (!currentSecretId && !value) {
                    showError('Secret value is required for new secrets');
                    return;
                }

                const secretData = {
                    name: name,
                    value: value,
                    description: description
                };

                if (expiry) {
                    secretData.expiresAt = expiry;
                }

                const url = currentSecretId ? `/api/secrets/${currentSecretId}` : '/api/secrets';
                const method = currentSecretId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    },
                    body: JSON.stringify(secretData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(currentSecretId ? 'Secret updated successfully!' : 'Secret created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('secretModal')).hide();
                    loadSecrets();
                    loadStats();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save secret');
                }
            } catch (error) {
                console.error('Error saving secret:', error);
                showError('Failed to save secret: ' + error.message);
            }
        }

        // View secret details
        async function viewSecret(id) {
            try {
                const response = await fetch(`/api/secrets/${id}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    const secret = await response.json();
                    currentSecretData = secret;
                    
                    document.getElementById('viewSecretName').textContent = secret.name;
                    
                    // Handle expired secrets
                    if (secret.isExpired) {
                        document.getElementById('viewSecretValue').innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> This secret has expired and its value can no longer be accessed</span>';
                        document.getElementById('viewSecretValue').style.color = '#dc3545';
                    } else {
                        document.getElementById('viewSecretValue').textContent = secret.value;
                        document.getElementById('viewSecretValue').style.color = 'inherit';
                    }
                    
                    document.getElementById('viewSecretDescription').textContent = secret.description || 'No description';
                    document.getElementById('viewSecretCreated').textContent = formatDate(secret.createdAt);
                    document.getElementById('viewSecretUpdated').textContent = formatDate(secret.updatedAt);
                    document.getElementById('viewSecretVersion').textContent = secret.version;
                    document.getElementById('viewSecretExpires').textContent = secret.expiresAt ? formatDate(secret.expiresAt) : 'Never';

                    // Hide edit button for expired secrets
                    const editButton = document.getElementById('editButtonInModal');
                    if (secret.isExpired) {
                        editButton.style.display = 'none';
                    } else {
                        editButton.style.display = 'inline-block';
                    }

                    new bootstrap.Modal(document.getElementById('viewSecretModal')).show();
                } else {
                    throw new Error('Failed to load secret details');
                }
            } catch (error) {
                console.error('Error viewing secret:', error);
                showError('Failed to load secret details: ' + error.message);
            }
        }

        // Edit secret
        function editSecret(id) {
            const secret = secretsList.find(s => s.id === id);
            if (secret) {
                // Prevent editing expired secrets
                if (secret.isExpired) {
                    showError('Cannot edit expired secrets');
                    return;
                }
                
                currentSecretId = id;
                document.getElementById('modalTitle').textContent = 'Edit Secret';
                document.getElementById('secretName').value = secret.name;
                document.getElementById('secretDescription').value = secret.description || '';
                
                // For editing, we don't show the current value for security
                document.getElementById('secretValue').value = '';
                document.getElementById('secretValue').placeholder = 'Enter new value (leave empty to keep current value)';
                // Make value field not required for edits
                document.getElementById('secretValue').required = false;
                
                if (secret.expiresAt) {
                    const expiryDate = new Date(secret.expiresAt);
                    const localDateTime = expiryDate.toISOString().slice(0, 16);
                    document.getElementById('secretExpiry').value = localDateTime;
                } else {
                    document.getElementById('secretExpiry').value = '';
                }

                new bootstrap.Modal(document.getElementById('secretModal')).show();
            }
        }

        // Edit current secret from view modal
        function editCurrentSecret() {
            if (currentSecretData) {
                // Prevent editing expired secrets
                if (currentSecretData.isExpired) {
                    showError('Cannot edit expired secrets');
                    return;
                }
                
                bootstrap.Modal.getInstance(document.getElementById('viewSecretModal')).hide();
                currentSecretId = currentSecretData.id;
                document.getElementById('modalTitle').textContent = 'Edit Secret';
                document.getElementById('secretName').value = currentSecretData.name;
                document.getElementById('secretDescription').value = currentSecretData.description || '';
                document.getElementById('secretValue').value = '';
                document.getElementById('secretValue').placeholder = 'Enter new value (leave empty to keep current value)';
                // Make value field not required for edits
                document.getElementById('secretValue').required = false;
                
                if (currentSecretData.expiresAt) {
                    const expiryDate = new Date(currentSecretData.expiresAt);
                    const localDateTime = expiryDate.toISOString().slice(0, 16);
                    document.getElementById('secretExpiry').value = localDateTime;
                } else {
                    document.getElementById('secretExpiry').value = '';
                }

                new bootstrap.Modal(document.getElementById('secretModal')).show();
            }
        }

        // Delete secret
        function deleteSecret(id, name) {
            currentSecretId = id;
            document.getElementById('deleteSecretName').textContent = name;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // Confirm delete
        async function confirmDelete() {
            try {
                const response = await fetch(`/api/secrets/${currentSecretId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                    }
                });

                if (response.ok) {
                    showSuccess('Secret deleted successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    loadSecrets();
                    loadStats();
                } else {
                    throw new Error('Failed to delete secret');
                }
            } catch (error) {
                console.error('Error deleting secret:', error);
                showError('Failed to delete secret: ' + error.message);
            }
        }

        // Copy to clipboard
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Copied to clipboard!');
            }).catch(() => {
                showError('Failed to copy to clipboard');
            });
        }

        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // Show success message
        function showSuccess(message) {
            // Create a temporary success alert
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }

        // Show error message
        function showError(message) {
            // Create a temporary error alert
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/index.html';
        }

        // Auto-refresh secrets every 30 seconds
        setInterval(() => {
            loadSecrets();
            loadStats();
        }, 30000);

        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });

            // Set active nav link based on current page
            const currentPage = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html> 