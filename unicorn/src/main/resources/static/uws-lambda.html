<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWS-Lambda - Unicorn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #495057;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-link i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
        }

        .top-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar-toggle {
                display: block !important;
            }
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }
        .btn-logout {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            color: white;
            font-weight: 600;
        }
        .btn-logout:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
            color: white;
            transform: translateY(-2px);
        }
        .editor-container {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .execution-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .error-badge {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .language-badge {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            background: #f8f9fa;
        }
        .nav-tabs .nav-link.active {
            background: #007bff;
            color: white;
        }
        
        /* Resource limits styling */
        .resource-limits-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.35rem;
        }
        .resource-limits-card .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #e3e6f0;
            font-weight: 600;
        }
        .resource-input {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
        }
        .resource-input:focus {
            border-color: #bac8f3;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        .resource-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
            border-radius: 0.35rem;
        }
        
        /* Modal styles for non-Bootstrap modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: block;
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1040;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard.html" class="sidebar-brand">🦄 Unicorn</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="/dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-billing.html" class="nav-link">
                    <i class="fas fa-credit-card"></i>
                    UWS-Billing
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-monitoring.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    UWS-Monitoring
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-s3.html" class="nav-link">
                    <i class="fas fa-cloud"></i>
                    UWS-S3
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-compute.html" class="nav-link">
                    <i class="fas fa-server"></i>
                    UWS-Compute
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-lambda.html" class="nav-link">
                    <i class="fas fa-code"></i>
                    UWS-Lambda
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-rdb.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-RDB
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-sqs.html" class="nav-link">
                    <i class="fas fa-envelope-open-text"></i>
                    UWS-SQS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-nosql.html" class="nav-link">
                    <i class="fas fa-database"></i>
                    UWS-NoSQL
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-ai.html" class="nav-link">
                    <i class="fas fa-brain"></i>
                    UWS-AI
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-secrets.html" class="nav-link">
                    <i class="fas fa-key"></i>
                    UWS-Secrets
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-dns.html" class="nav-link">
                    <i class="fas fa-globe"></i>
                    UWS-DNS
                </a>
            </div>
            <div class="nav-item">
                <a href="/uws-iam.html" class="nav-link">
                    <i class="fas fa-users-cog"></i>
                    UWS-IAM
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="sidebar-toggle me-3" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0">UWS-Lambda Function Service</h4>
            </div>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>

        <div class="container">
        <div class="main-card">
            <div class="text-center mb-4">
                <h1>🚀 UWS-Lambda Function Service</h1>
                <p class="lead">Create and execute serverless functions in isolated containers</p>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs" id="lambdaTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="create-tab" onclick="switchTab('create')" type="button" role="tab">
                        ✨ Create Function
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="functions-tab" onclick="switchTab('functions')" type="button" role="tab">
                        📋 My Functions
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="execute-tab" onclick="switchTab('execute')" type="button" role="tab">
                        ⚡ Execute
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitoring-tab" onclick="switchTab('monitoring')" type="button" role="tab">
                        📊 Monitoring
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="lambdaTabsContent">
                <!-- Create Function Tab -->
                <div class="tab-pane fade show active" id="create" role="tabpanel">
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Create New Lambda Function</h5>
                                </div>
                                <div class="card-body">
                                    <form id="createLambdaForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="functionName" class="form-label">Function Name</label>
                                                    <input type="text" class="form-control" id="functionName" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="language" class="form-label">Programming Language</label>
                                                    <select class="form-select" id="language" required>
                                                        <option value="">Select language</option>
                                                        <option value="javascript">JavaScript (Node.js)</option>
                                                        <option value="python">Python</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Resource Limits Configuration -->
                                        <div class="card mb-3 resource-limits-card">
                                            <div class="card-header">
                                                <h6 class="mb-0">⚙️ Resource Limits</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label for="cpuLimit" class="form-label">CPU Limit (cores)</label>
                                                            <input type="number" class="form-control resource-input" id="cpuLimit" min="1" max="8" value="1">
                                                            <small class="form-text text-muted">1-8 CPU cores (default: 1)</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label for="memoryLimit" class="form-label">Memory Limit (MB)</label>
                                                            <input type="number" class="form-control resource-input" id="memoryLimit" min="128" max="8192" value="512">
                                                            <small class="form-text text-muted">128-8192 MB (default: 512)</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label for="timeoutLimit" class="form-label">Timeout (seconds)</label>
                                                            <input type="number" class="form-control resource-input" id="timeoutLimit" min="1" max="300" value="30">
                                                            <small class="form-text text-muted">1-300 seconds (default: 30)</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="alert alert-info resource-info">
                                                    <small>
                                                        <strong>Resource Limits Info:</strong><br>
                                                        • CPU: Limits the number of CPU cores available to your function<br>
                                                        • Memory: Sets maximum memory usage in megabytes<br>
                                                        • Timeout: Maximum execution time before automatic termination<br>
                                                        • These limits help prevent resource abuse and ensure fair usage
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="codeEditor" class="form-label">Source Code</label>
                                            <div id="codeEditor" class="editor-container"></div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="testInput" class="form-label">Test Input (JSON)</label>
                                            <textarea class="form-control" id="testInput" rows="3" placeholder='{"name": "World", "number": 42}' onblur="validateJSON(this)">{"name": "World", "number": 42}</textarea>
                                            <small class="form-text text-muted">Enter valid JSON format: {"key": "value", "number": 42}</small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">Create Function</button>
                                            <button type="button" class="btn btn-success" onclick="testFunction()">Test Function</button>
                                            <button type="button" class="btn btn-info" onclick="testAuth()">Test Auth</button>
                                            <button type="button" class="btn btn-warning" onclick="switchTab('functions')">Go to My Functions</button>
                                            <button type="button" class="btn btn-secondary" onclick="switchTab('execute')">Go to Execute</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Functions Tab -->
                <div class="tab-pane fade" id="functions" role="tabpanel">
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>My Lambda Functions</h5>
                                    <div>
                                        <button class="btn btn-primary btn-sm" onclick="loadFunctions()">Refresh</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="functionsTable"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Execute Tab -->
                <div class="tab-pane fade" id="execute" role="tabpanel">
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Execute Function</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="executeFunction" class="form-label">Select Function</label>
                                                <select class="form-select" id="executeFunction">
                                                    <option value="">Select a function to execute</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="executeInput" class="form-label">Input Data (JSON)</label>
                                                <textarea class="form-control" id="executeInput" rows="5" placeholder='{"name": "World", "number": 42}' onblur="validateJSON(this)">{"name": "World", "number": 42}</textarea>
                                                <small class="form-text text-muted">Enter valid JSON format: {"key": "value", "number": 42}</small>
                                            </div>
                                            <button class="btn btn-success" onclick="executeSelectedFunction()">Execute Function</button>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Execution Results</h6>
                                            <div id="executionResults" class="execution-output">No execution results yet.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monitoring Tab -->
    <div class="tab-pane fade" id="monitoring" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>📊 System Monitoring & Statistics</h5>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="loadStats()">Refresh Stats</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-primary text-white mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Total Executions</h6>
                                        <h3 id="totalExecutions">-</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-success text-white mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Success Rate</h6>
                                        <h3 id="successRate">-</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-info text-white mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Successful Executions</h6>
                                        <h4 id="successfulExecutions">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-white mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Failed Executions</h6>
                                        <h4 id="failedExecutions">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-secondary text-white mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Active Users</h6>
                                        <h4 id="activeUsers">-</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>System Health</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>Cache Size:</strong> <span id="cacheSize">-</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Rate Limit Entries:</strong> <span id="rateLimitMapSize">-</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Last Updated:</strong> <span id="lastUpdated">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>Rate Limits</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>Max Requests/Minute:</strong> 30
                                        </div>
                                        <div class="mb-2">
                                            <strong>Max Requests/Hour:</strong> 1000
                                        </div>
                                        <div class="mb-2">
                                            <strong>Max Functions/User:</strong> 50
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Logs Modal -->
    <div class="modal fade" id="logsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Execution Logs</h5>
                    <button type="button" class="btn-close" onclick="hideLogsModal()"></button>
                </div>
                <div class="modal-body">
                    <div id="logsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wait for Bootstrap to load
        function waitForBootstrap() {
            if (typeof bootstrap !== 'undefined') {
                initializeTabs();
            } else {
                setTimeout(waitForBootstrap, 100);
            }
        }
        
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName)
            
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active')
            })
            
            // Remove active from all tabs
            document.querySelectorAll('#lambdaTabs button').forEach(btn => {
                btn.classList.remove('active')
            })
            
            // Show target tab pane
            const targetPane = document.getElementById(tabName)
            if (targetPane) {
                targetPane.classList.add('show', 'active')
                console.log('Tab pane found and activated:', tabName)
            } else {
                console.error('Tab pane not found:', tabName)
            }
            
            // Activate the clicked tab button
            const targetTab = document.getElementById(tabName + '-tab')
            if (targetTab) {
                targetTab.classList.add('active')
                console.log('Tab button activated:', tabName + '-tab')
            } else {
                console.error('Tab button not found:', tabName + '-tab')
            }
            
            // Load functions if switching to functions tab
            if (tabName === 'functions') {
                console.log('Loading functions for functions tab...')
                loadFunctions()
            }
            
            // Load stats if switching to monitoring tab
            if (tabName === 'monitoring') {
                console.log('Loading stats for monitoring tab...')
                loadStats()
            }
        }

        function initializeTabs() {
            console.log('Initializing tabs...');
            // Tabs are now handled by the switchTab function
            console.log('Tab switching ready - use switchTab() function');
        }
        let editor;
        let currentToken;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('codeEditor'), {
                value: 'console.log("Hello, World!");',
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false }
            });
        });

        // Check authentication on page load
        window.addEventListener('load', function() {
            currentToken = localStorage.getItem('jwtToken');
            if (!currentToken) {
                alert('Please login first');
                window.location.href = '/login.html';
                return;
            }
            loadFunctions();
            
            // Test server connectivity and token validity
            console.log('Testing server connectivity...')
            console.log('Current token:', currentToken ? 'Present' : 'Missing')
            
            // Test if we can access a protected endpoint
            fetch('/api/lambdas', {
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            })
            .then(response => {
                console.log('Lambda API test - Status:', response.status)
                if (response.status === 401) {
                    console.error('Token is invalid or expired')
                    alert('Your session has expired. Please login again.')
                    window.location.href = '/login.html'
                } else if (response.status === 200) {
                    console.log('Token is valid, API is working')
                }
            })
            .catch(error => {
                console.error('API test failed:', error)
            })
            
            // Wait for Bootstrap to load and initialize tabs
            waitForBootstrap();
        });

        // Create Lambda Function
        document.getElementById('createLambdaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('functionName').value;
            const language = document.getElementById('language').value;
            const code = editor.getValue();
            const cpuLimit = document.getElementById('cpuLimit').value;
            const memoryLimit = document.getElementById('memoryLimit').value;
            const timeoutLimit = document.getElementById('timeoutLimit').value;

            if (!name || !language || !code.trim()) {
                alert('Please fill in all required fields');
                return;
            }

            fetch('/api/lambdas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + currentToken
                },
                body: JSON.stringify({
                    name: name,
                    language: language,
                    code: code,
                    cpuLimit: parseInt(cpuLimit),
                    memoryLimit: parseInt(memoryLimit),
                    timeoutLimit: parseInt(timeoutLimit)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert('Function created successfully!');
                    // Reset form fields
                    document.getElementById('functionName').value = '';
                    document.getElementById('language').value = '';
                    document.getElementById('cpuLimit').value = '1';
                    document.getElementById('memoryLimit').value = '512';
                    document.getElementById('timeoutLimit').value = '30';
                    document.getElementById('testInput').value = '{"name": "World", "number": 42}';
                    editor.setValue('console.log("Hello, World!");');
                    loadFunctions();
                } else {
                    alert('Error creating function: ' + data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating function');
            });
        });

        // Test Function
        function testFunction() {
            const language = document.getElementById('language').value;
            const code = editor.getValue();
            const input = document.getElementById('testInput').value;
            const cpuLimit = document.getElementById('cpuLimit').value;
            const memoryLimit = document.getElementById('memoryLimit').value;
            const timeoutLimit = document.getElementById('timeoutLimit').value;

            if (!language || !code.trim()) {
                alert('Please select a language and write some code');
                return;
            }

            // Validate and format input JSON
            let formattedInput = '{}';
            if (input.trim()) {
                try {
                    // Parse and re-stringify to ensure valid JSON
                    const parsedInput = JSON.parse(input.trim());
                    formattedInput = JSON.stringify(parsedInput);
                    console.log('Formatted input:', formattedInput);
                } catch (e) {
                    alert('Invalid JSON input: ' + e.message + '\nPlease enter valid JSON format like: {"name": "Alice", "number": 42}');
                    return;
                }
            }

            // Create a temporary function for testing
            fetch('/api/lambdas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + currentToken
                },
                body: JSON.stringify({
                    name: 'test-' + Date.now(),
                    language: language,
                    code: code,
                    cpuLimit: parseInt(cpuLimit),
                    memoryLimit: parseInt(memoryLimit),
                    timeoutLimit: parseInt(timeoutLimit)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    // Execute the test function
                    return fetch(`/api/lambdas/${data.id}/execute`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + currentToken
                        },
                        body: JSON.stringify({ input: formattedInput })
                    });
                } else {
                    throw new Error('Error creating test function: ' + data);
                }
            })
            .then(response => response.json())
            .then(data => {
                let result = `Execution Results:\n`;
                result += `Success: ${data.success ? 'Yes' : 'No'}\n`;
                result += `Execution Time: ${data.executionTime}ms\n\n`;
                
                if (data.output) {
                    result += `Output:\n${data.output}\n\n`;
                }
                
                if (data.error) {
                    result += `Error:\n${data.error}\n\n`;
                }

                document.getElementById('executionResults').textContent = result;
                alert('Test completed! Check the execution results.');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error testing function: ' + error.message);
            });
        }

        // Load Functions
        function loadFunctions() {
            console.log('Loading functions...')
            console.log('Using token:', currentToken ? currentToken.substring(0, 20) + '...' : 'No token')
            
            // Show loading message
            document.getElementById('functionsTable').innerHTML = '<p class="text-info">Loading functions...</p>';
            
            fetch('/api/lambdas', {
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            })
            .then(response => {
                console.log('Response status:', response.status)
                console.log('Response headers:', response.headers)
                
                if (response.status === 401) {
                    console.error('Authentication failed - token may be invalid or expired')
                    alert('Authentication failed. Please login again.')
                    window.location.href = '/login.html'
                    return
                }
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status)
                }
                return response.json()
            })
            .then(data => {
                if (data) {
                    console.log('Functions loaded:', data)
                    displayFunctions(data);
                    updateExecuteDropdown(data);
                    
                    // Show success message if no functions
                    if (data.length === 0) {
                        console.log('No functions found - this is normal for new users')
                    }
                }
            })
            .catch(error => {
                console.error('Error loading functions:', error);
                document.getElementById('functionsTable').innerHTML = '<p class="text-danger">Error loading functions: ' + error.message + '</p>';
            });
        }

        // Display Functions
        function displayFunctions(functions) {
            const container = document.getElementById('functionsTable');
            
            if (functions.length === 0) {
                container.innerHTML = '<p class="text-muted">No functions created yet.</p>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Language</th>
                                <th>Resource Limits</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            functions.forEach(func => {
                const createdAt = new Date(func.createdAt).toLocaleString();
                const resourceInfo = `CPU: ${func.cpuLimit || 1} | Memory: ${func.memoryLimit || 512}MB | Timeout: ${func.timeoutLimit || 30}s`;
                
                html += `
                    <tr>
                        <td><strong>${func.name}</strong></td>
                        <td><span class="language-badge">${func.language}</span></td>
                        <td><small class="text-muted">${resourceInfo}</small></td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="executeFunction(${func.id})">Execute</button>
                            <button class="btn btn-sm btn-info" onclick="viewLogs(${func.id})">Logs</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFunction(${func.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Update Execute Dropdown
        function updateExecuteDropdown(functions) {
            const select = document.getElementById('executeFunction');
            select.innerHTML = '<option value="">Select a function to execute</option>';
            
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = `${func.name} (${func.language})`;
                select.appendChild(option);
            });
        }

        // Execute Selected Function
        function executeSelectedFunction() {
            const functionId = document.getElementById('executeFunction').value;
            const input = document.getElementById('executeInput').value;

            if (!functionId) {
                alert('Please select a function to execute');
                return;
            }

            executeFunction(functionId, input);
        }

        // Execute Function
        function executeFunction(functionId, input = null) {
            console.log('Executing function:', functionId, 'with input:', input);
            let inputData = input || document.getElementById('executeInput').value;

            // Validate and format input JSON
            if (inputData && inputData.trim()) {
                try {
                    // Parse and re-stringify to ensure valid JSON
                    const parsedInput = JSON.parse(inputData.trim());
                    inputData = JSON.stringify(parsedInput);
                    console.log('Formatted input data:', inputData);
                } catch (e) {
                    alert('Invalid JSON input: ' + e.message + '\nPlease enter valid JSON format like: {"name": "Alice", "number": 42}');
                    return;
                }
            } else {
                inputData = '{}';
            }

            fetch(`/api/lambdas/${functionId}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + currentToken
                },
                body: JSON.stringify({ input: inputData })
            })
            .then(response => {
                console.log('Execute response status:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Execute response data:', data);
                let result = `Execution Results:\n`;
                result += `Success: ${data.success ? 'Yes' : 'No'}\n`;
                result += `Execution Time: ${data.executionTime}ms\n`;
                result += `Timestamp: ${new Date(data.timestamp).toLocaleString()}\n\n`;
                
                if (data.output) {
                    result += `Output:\n${data.output}\n\n`;
                }
                
                if (data.error) {
                    result += `Error:\n${data.error}\n\n`;
                }

                document.getElementById('executionResults').textContent = result;
                
                if (!input) {
                    // Switch to execute tab if called from functions table
                    switchTab('execute');
                }
            })
            .catch(error => {
                console.error('Error executing function:', error);
                alert('Error executing function: ' + error.message);
            });
        }

        // View Logs
        function viewLogs(functionId) {
            console.log('Viewing logs for function:', functionId);
            fetch(`/api/lambdas/${functionId}/logs`, {
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            })
            .then(response => {
                console.log('Logs response status:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Logs response data:', data);
                displayLogs(data);
                showLogsModal();
            })
            .catch(error => {
                console.error('Error loading logs:', error);
                alert('Error loading logs: ' + error.message);
            });
        }

        // Display Logs
        function displayLogs(logs) {
            const container = document.getElementById('logsContent');
            
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-muted">No execution logs found.</p>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Input</th>
                                <th>Output</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            logs.forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const status = log.success ? 
                    '<span class="success-badge">Success</span>' : 
                    '<span class="error-badge">Failed</span>';
                
                html += `
                    <tr>
                        <td>${timestamp}</td>
                        <td>${status}</td>
                        <td>${log.executionTime}ms</td>
                        <td><small>${log.input || '{}'}</small></td>
                        <td>
                            <small>
                                ${log.output ? log.output.substring(0, 50) + '...' : ''}
                                ${log.error ? '<br><span class="text-danger">' + log.error.substring(0, 50) + '...</span>' : ''}
                            </small>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function showLogsModal() {
            const modal = document.getElementById('logsModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'modalBackdrop';
            document.body.appendChild(backdrop);
        }

        function hideLogsModal() {
            const modal = document.getElementById('logsModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            
            // Remove backdrop
            const backdrop = document.getElementById('modalBackdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }

        // Delete Function
        function deleteFunction(functionId) {
            console.log('Deleting function:', functionId);
            if (!confirm('Are you sure you want to delete this function?')) {
                return;
            }

            fetch(`/api/lambdas/${functionId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.text();
            })
            .then(data => {
                console.log('Delete response:', data);
                alert('Function deleted successfully');
                loadFunctions();
            })
            .catch(error => {
                console.error('Error deleting function:', error);
                alert('Error deleting function: ' + error.message);
            });
        }

        // Language change handler
        document.getElementById('language').addEventListener('change', function() {
            const language = this.value;
            if (editor) {
                const model = editor.getModel();
                if (language === 'javascript') {
                    monaco.editor.setModelLanguage(model, 'javascript');
                    editor.setValue('console.log("Hello, World!");');
                } else if (language === 'python') {
                    monaco.editor.setModelLanguage(model, 'python');
                    editor.setValue('print("Hello, World!")');
                }
            }
        });

        function testAuth() {
            console.log('Testing authentication...')
            console.log('Token:', currentToken ? currentToken.substring(0, 50) + '...' : 'No token')
            
            if (!currentToken) {
                alert('❌ No JWT token found. Please login first.')
                window.location.href = '/login.html'
                return
            }
            
            // Decode token to check expiration
            try {
                const payload = JSON.parse(atob(currentToken.split('.')[1]))
                const expirationTime = payload.exp * 1000
                const currentTime = Date.now()
                
                if (currentTime >= expirationTime) {
                    alert('❌ Token has expired. Please login again.')
                    window.location.href = '/login.html'
                    return
                }
                
                console.log('Token expires at:', new Date(expirationTime).toLocaleString())
            } catch (e) {
                console.error('Error decoding token:', e)
            }
            
            fetch('/api/lambdas', {
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            })
            .then(response => {
                console.log('Auth test response:', response.status)
                if (response.status === 200) {
                    alert('✅ Authentication successful! API is working.')
                } else if (response.status === 401) {
                    alert('❌ Authentication failed. Please login again.')
                    window.location.href = '/login.html'
                } else {
                    alert('⚠️ Unexpected response: ' + response.status)
                }
            })
            .catch(error => {
                console.error('Auth test error:', error)
                alert('❌ Authentication test failed: ' + error.message)
            })
        }

        function validateJSON(textarea) {
            const value = textarea.value.trim();
            if (value === '') return;
            
            try {
                JSON.parse(value);
                textarea.classList.remove('is-invalid');
                textarea.classList.add('is-valid');
            } catch (e) {
                textarea.classList.remove('is-valid');
                textarea.classList.add('is-invalid');
                console.log('Invalid JSON:', e.message);
            }
        }

        function setJSONExample(jsonString) {
            // Find the active input field
            const testInput = document.getElementById('testInput');
            const executeInput = document.getElementById('executeInput');
            
            if (testInput && testInput.closest('.tab-pane').classList.contains('show')) {
                testInput.value = jsonString;
                validateJSON(testInput);
            } else if (executeInput && executeInput.closest('.tab-pane').classList.contains('show')) {
                executeInput.value = jsonString;
                validateJSON(executeInput);
            }
        }

        function testButtons() {
            console.log('Testing button functionality...')
            alert('Testing button functionality...')
            
            // Test if functions are accessible
            console.log('Functions table element:', document.getElementById('functionsTable'))
            console.log('Current token:', currentToken ? 'Present' : 'Missing')
            
            alert('Button test completed! Check console for details.')
        }

        function testTabSwitch() {
            console.log('Testing tab switch...')
            alert('Testing tab switching functionality...')
            
            // Test switching to different tabs
            switchTab('create')
            setTimeout(() => {
                switchTab('execute')
                setTimeout(() => {
                    switchTab('functions')
                    alert('Tab switching test completed! All tabs should work now.')
                }, 1000)
            }, 1000)
            
            console.log('Tab switch test completed')
        }

        function logout() {
            localStorage.removeItem('jwtToken');
            alert('Logged out successfully!');
            window.location.href = '/index.html';
        }

        function loadStats() {
            console.log('Loading execution statistics...')
            
            fetch('/api/lambdas/stats', {
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            })
            .then(response => {
                console.log('Stats response status:', response.status)
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status)
                }
                return response.json()
            })
            .then(data => {
                console.log('Stats data:', data)
                
                // Update statistics display
                document.getElementById('totalExecutions').textContent = data.totalExecutions || 0
                document.getElementById('successfulExecutions').textContent = data.successfulExecutions || 0
                document.getElementById('failedExecutions').textContent = data.failedExecutions || 0
                document.getElementById('activeUsers').textContent = data.activeUsers || 0
                document.getElementById('cacheSize').textContent = data.cacheSize || 0
                document.getElementById('rateLimitMapSize').textContent = data.rateLimitMapSize || 0
                
                // Format success rate
                const successRate = data.successRate || 0
                document.getElementById('successRate').textContent = successRate.toFixed(1) + '%'
                
                // Update last updated timestamp
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString()
            })
            .catch(error => {
                console.error('Error loading stats:', error)
                alert('Error loading statistics: ' + error.message)
            })
        }

        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });

            // Set active nav link based on current page
            const currentPage = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html> 